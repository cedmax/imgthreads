org: cedmax
app: img-threads
service: imgthreads

provider:
  name: aws
  region: eu-west-1
  runtime: nodejs12.x
  iamRoleStatements:
    - Effect: 'Allow'
      Action:
        - 's3:PutObject'
        - 's3:PutObjectAcl'
        - 's3:getObject'
        - 's3:PutObjectAcl'
      Resource:
        - 'arn:aws:s3:::${file(./config.json):bucket}-uploads'
        - 'arn:aws:s3:::${file(./config.json):bucket}-uploads/*'
        - 'arn:aws:s3:::${file(./config.json):bucket}'
        - 'arn:aws:s3:::${file(./config.json):bucket}/*'
    - Effect: Allow
      Action:
        - dynamodb:GetItem
        - dynamodb:PutItem
      Resource: arn:aws:dynamodb:*:*:table/${file(./config.json):dynamoTable}
  s3:
    uploadBucket:
      name: ${file(./config.json):bucket}-uploads
      AccessControl: BucketOwnerFullControl
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT]
            AllowedOrigins: ['*']
    destinationBucket:
      name: ${file(./config.json):bucket}
      AccessControl: PublicRead
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT]
            AllowedOrigins: ['*']

functions:
  upload:
    handler: uploader.handler
    events:
      - http:
          path: upload
          method: post
          cors: true
  resize:
    handler: resizer.handler
    layers:
      - arn:aws:lambda:eu-west-1:175033217214:layer:graphicsmagick:2
    events:
      - s3:
          bucket: uploadBucket
          event: s3:ObjectCreated:*
  associate:
    handler: firebase.handler
    events:
      - s3:
          bucket: destinationBucket
          event: s3:ObjectCreated:*
          rules:
            - prefix: r/
resources:
  Resources:
    DynamoDbTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${file(./config.json):dynamoTable}
        AttributeDefinitions:
          - AttributeName: Id
            AttributeType: S
        KeySchema:
          - AttributeName: Id
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
